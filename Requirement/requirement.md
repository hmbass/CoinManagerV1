# requirement.md — 업비트 기반 단타 자동매매 시스템(스캐너·신호·주문)

> 본 문서는 Cursor 기반 개발을 전제로 한 **요구사항(Requirements)** 정의서입니다. 목표는 “매일 2\~3개 종목 선별 → 규칙 기반 단타 진입/청산 → 손실 제한 및 로그·리포팅 자동화”입니다. 본 문서는 **설계·구현·테스트·운영** 전 단계의 기준선으로 사용합니다.

---

## 0. 개요

* **프로젝트명**: Upbit Day-Trade Automator (UDA)
* **목표**: 업비트 공개 API/WS 데이터를 이용해, 규칙 기반으로 **그날 매수 가능한 후보를 기계적으로 선별**하고 **트리거 충족 시 자동 주문**하며, **위험 한도**와 **일일 중단 규칙**을 강제하는 시스템을 구축.
* **철학**: “매일 고정 수익”이 아닌 **기대값(Expectancy) 극대화**와 **손실 한도 준수**.
* **범위(Scope)**: 현물 위주(필수), 선물/레버리지(선택) — 초기 버전은 **현물**만.
* **시간대**: Asia/Seoul(KST) 고정. 주요 실행 창 09:10–13:00, 17:10–19:00.

---

## 1. 용어 정의

* **RVOL**: 최근 5분 거래량 ÷ 과거 5분 평균 거래량(최근 20개) — 거래량 급증 지표.
* **상대강도(RS)**: 종목의 최근 60분 수익률 − **KRW-BTC**의 최근 60분 수익률.
* **세션 VWAP(sVWAP)**: 해당 일자 00:00(KST) 이후 누적 거래량 가중 평균가.
* **ORB**: 시초 60분(09:00–10:00) 고/저로 정의된 범위의 돌파 신호.
* **1R**: 진입가 대비 손절가 거리(리스크 단위). 익절/손절 및 기대값 계산 기본 단위.

---

## 2. 시스템 아키텍처(개요)

```mermaid
flowchart LR
  A[데이터 수집 레이어\nREST/WS (Upbit)] --> B[피처 계산\nRVOL/RS/VWAP/EMA/ATR]
  B --> C[스코어링 & 후보선정\nTop2~3]
  C --> D[신호 엔진\nORB / sVWAP Pullback / Sweep]
  D --> E[주문/체결 모듈\nIOC/FOK/BEST, OCO-like]
  E --> F[리스크 가드\n포지션 크기, DDL(-1%), 연속 손절 차단]
  F --> G[로깅/저널\n트레이드 일지, 체결, 파라미터]
  G --> H[리포팅/대시보드\n일/주/월 성과]
  A --> I[모니터링\n레이트리밋/예외]
```

---

## 3. 기능 요구사항(FR)

### FR-1. 마켓/심사 필터링

* **설명**: 업비트 마켓 목록을 조회하고 **경고/유의 종목**과 **신규상장 직후**를 제외한다.
* **세부**:

  * 엔드포인트: `/v1/market/all?isDetails=true` (세부 플래그 있으면 사용, 없으면 `market_warning` 사용)
  * KRW 마켓만 사용(`KRW-*`).
  * 제외 규칙: 경고/유의 플래그가 존재하거나, 상장 후 N일(기본 7일) 미만.
* **수용 기준(AC)**:

  * 경고 종목이 후보 목록에 포함되지 않는다.
  * 파라미터로 제외 기간 N을 변경 가능.

### FR-2. 캔들·호가·체결 데이터 수집

* **설명**: 5분봉 기준 캔들 200개 이상 확보, 오더북으로 스프레드/깊이 산출, WS로 실시간 갱신(선택).
* **세부**:

  * 캔들: `/v1/candles/minutes/{unit}` (기본 unit=5, count≥200)
  * 오더북: `/v1/orderbook?markets=...` (KRW 마켓 level 파라미터 지원 시 확대)
  * WS: `ticker`/`trade` 채널 구독, 심볼은 후보 + 코어(BTC/ETH/SOL).
* **AC**:

  * 데이터 누락/역정렬 방지(과거→현재 정렬).
  * WS 연결 단절 시 **자동 재연결** 및 백오프.

### FR-3. 피처 계산

* **설명**: 각 종목에 대해 RVOL, RS, EMA20/50, sVWAP, ATR(14)을 계산.
* **세부**:

  * sVWAP: 당일 00:00(KST) 이후 `Σ(Price*Volume)/Σ(Volume)`.
  * RS: 60분 수익률 차이(종목 − KRW-BTC).
  * RVOL: `최근 5m 거래량 / 최근 20개 5m 평균`.
* **AC**:

  * 결측/분모 0 방지(샘플 수 부족 시 해당 종목 스킵).

### FR-4. 후보 스코어링 & 상위 2\~3개 선별

* **설명**: 아래 공식으로 스코어를 계산하고 상위 2\~3개만 반환.
* **스코어**: `0.4×RS + 0.3×RVOL_Z + 0.2×Trend + 0.1×Depth`

  * `Trend ∈ {0,1}`: (EMA20>EMA50 **and** Price>sVWAP)
  * `RVOL_Z`: (RVOL−1)/1.0 을 0\~3 범위로 클리핑(초기 단순 스케일)
  * `Depth`: log 스케일로 0\~1 정규화(오더북 총호가량 기반)
* **선행 필터**: RVOL≥2, 스프레드≤5bp, Trend=1
* **AC**:

  * 반환 목록 길이가 2\~3개 범위이며 스코어 내림차순.
  * 필터 미충족 종목은 포함되지 않음.

### FR-5. 진입 신호 엔진

* **설명**: 3종 세트업 중 최소 1개를 활성화하여 자동으로 진입 시그널 생성.
* **A) ORB 돌파**: 09:00–10:00 고/저 박스를 정의, 상단 + `0.1×ATR(5m)` 돌파 & 돌파봉 거래량≥최근20봉평균×1.5
* **B) sVWAP 되돌림 매수**: Price>sVWAP, 5m EMA20>50, sVWAP±0.25×ATR 구간 반전 캔들 확인
* **C) 유동성 스윕 리버설(보수적)**: 직전 스윙 저/고 짧은 관통 및 신속 복귀 + 거래량 스파이크
* **AC**:

  * 각 신호는 **엔트리/손절/초기익절(1R\~1.5R)** 값을 계산해 주문 모듈로 전달.
  * 하루 한 전략당 최대 2회 재시도 제한.

### FR-6. 주문/체결 모듈

* **설명**: 업비트 주문 API(JWT) 사용, **IOC/FOK/BEST** 지원, 체결/부분체결 처리.
* **세부**:

  * 주문 전 **포지션 크기** 계산(아래 FR-7) 후 수량 산출.
  * OCO-like: 손절/익절 예약(없다면 체결 후 자동 지정 주문 체배치).
  * 슬리피지 보호: 지정가 편차 한도(기본 5bp) 초과 시 취소.
* **AC**:

  * 체결/취소/예외가 모두 **구체적 로그**로 남는다.
  * 동일 심볼 **중복 주문 방지(멱등성)** 보장.

### FR-7. 리스크 가드

* **설명**: 계좌 기준 1회 거래 손실 0.3\~0.5% 제한, 일손실(DDL) -1% 도달 시 당일 중단.
* **세부**:

  * 포지션 크기 = `허용손실액 / (엔트리 − 손절)`
  * 연속 손절 2회 시 해당 심볼 금일 거래 금지.
* **AC**:

  * 손절/익절/중단 트리거가 **전역 상태**로 공유되어 후속 주문 차단.

### FR-8. 로깅/리포팅/저널

* **설명**: 모든 의사결정 입력(피처, 파라미터)과 결과(주문, 체결, 손익)를 구조화 저장.
* **세부**:

  * 형식: CSV + JSONL(원시) + 콘솔 구조로그.
  * 리포트: 일일/주간 PnL, 승률, 기대값, 평균R, 최대낙폭, 거래별 스크린샷(선택).
* **AC**:

  * 하루 종료 시 자동 요약 파일 생성.

### FR-9. 설정/파라미터화

* **설명**: 모든 임계치(RVOL, 스프레드, 윈도, R스케일 등)와 시간창을 YAML/ENV로 외부화.
* **AC**:

  * 재배포 없이 파라미터만 수정 가능.

### FR-10. 시뮬레이션/백테스트(선택)

* **설명**: 과거 캔들 데이터로 **스캐너→신호→체결모사**까지 재현.
* **AC**:

  * 매수/매도 타임스탬프, 체결가, 슬리피지 모형 반영.

---

## 4. 비기능 요구사항(NFR)

* **성능/지연**: 스캐너 1회 전체 유니버스(최대 200 심볼) 처리 ≤ 20초, 신호→주문 왕복 ≤ 1.0초(WS 기반).
* **신뢰성**: WS 재연결, REST 재시도(지수백오프), 부분 실패 격리.
* **보안**: API 키는 `.env`/Secret Manager, IP 화이트리스트, 최소권한. 키 로테이션 절차 문서화.
* **관측성**: 헬스체크 엔드포인트, 메트릭(신호수/주문수/오류율/레이트리밋) 노출.
* **규정준수**: 거래소 약관/국내 규정 준수(자산/세무는 사용자 책임). 모의모드 제공.

---

## 5. 외부 API (참고)

* **마켓 목록**: `GET /v1/market/all?isDetails=true`
* **분봉 캔들**: `GET /v1/candles/minutes/{unit}?market=KRW-XXX&count=200`
* **오더북**: `GET /v1/orderbook?markets=KRW-XXX`
* **WS**: `wss://api.upbit.com/websocket/v1` (`ticker`/`trade`)
* **주문**: `POST /v1/orders` (JWT; 쿼리해시 포함)

> *주의*: 실제 엔드포인트·필드명은 변경될 수 있음. 런타임에서 **스키마 검증/가드** 필수.

---

## 6. 알고리즘 상세

* **RVOL**: `rv = vol[-1] / mean(vol[-21:-1])`
* **RS(60m)**: `rs = ret60(sym) − ret60(KRW-BTC)`
* **sVWAP**: `vwap_t = cumsum(price*volume)/cumsum(volume)` (기준: 당일 00:00 KST)
* **ATR(14)**: 표준 TR 기반 14기간 단순이동 평균.
* **Trend**: `(EMA20>EMA50) and (close > sVWAP)` → {0,1}
* **스코어**: `0.4*RS + 0.3*RVOL_Z + 0.2*Trend + 0.1*Depth`
* **ORB**: `OR_high=max(09:00–10:00)`, `OR_low=min(09:00–10:00)`
* **sVWAP Pullback**: `entry_zone = sVWAP ± 0.25*ATR` 반전 캔들 확인.
* **Sweep Reversal(선택)**: 직전 스윙 레벨 짧은 관통 + 신속 복귀 + 거래량 스파이크.
* **포지션 크기**: `qty = floor( (risk_cap * equity) / (entry - stop) )`
* **일중단(DDL)**: 당일 실현 PnL ≤ -1% → 신규 주문 금지, 열린 포지션만 관리.

---

## 7. 기본 파라미터(초기값)

| 항목       |                       기본 | 범위/비고       |
| -------- | -----------------------: | ----------- |
| RVOL 임계  |                      2.0 | 1.5\~3.0 튜닝 |
| 스프레드 한도  |                     5 bp | KRW 마켓 기준   |
| RS 기간    |                      60분 | 30/120 가능   |
| Trend 조건 |   EMA20>50 & close>sVWAP | 고정          |
| 후보 수     |                     2\~3 | 상위 스코어      |
| 거래 창     | 09:10–13:00, 17:10–19:00 | Asia/Seoul  |
| 1회 위험    |                0.3\~0.5% | 계좌 기준       |
| 일손실 컷    |                    -1.0% | 강제 중단       |

**구성 파일 예시(`config.yaml`)**

```yaml
exchange:
  base_url: https://api.upbit.com
  websocket_url: wss://api.upbit.com/websocket/v1
symbols:
  core: [KRW-BTC, KRW-ETH, KRW-SOL]
  exclude_warning: true
  exclude_newly_listed_days: 7
scanner:
  candle_unit: 5
  candle_count: 200
  rvol_threshold: 2.0
  spread_bp_max: 5
  rs_window_minutes: 60
  trend:
    use_vwap: true
    ema_fast: 20
    ema_slow: 50
  depth_normalize: log
signals:
  orb:
    use: true
    box_window: "09:00-10:00"
    breakout_atr_mult: 0.1
    volume_spike_mult: 1.5
  svwap_pullback:
    use: true
    zone_atr_mult: 0.25
  sweep_reversal:
    use: false
risk:
  per_trade_risk_pct: 0.004
  daily_drawdown_stop_pct: 0.01
  max_retries_per_setup: 2
  same_symbol_consecutive_losses_stop: 2
orders:
  slippage_bp_max: 5
  order_type: limit
  time_in_force: IOC
runtime:
  session_windows:
    - "09:10-13:00"
    - "17:10-19:00"
logging:
  level: INFO
  dir: ./runtime/logs
report:
  out_dir: ./runtime/reports
```

---

## 8. 예외/오류 처리 매트릭스

| 상황             | 감지         | 조치                    |
| -------------- | ---------- | --------------------- |
| REST 429/레이트리밋 | HTTP 상태/헤더 | 지수 백오프, 큐에 재스케줄       |
| WS 끊김          | 핑타임아웃/예외   | 재연결 N회, 실패 시 폴백(REST) |
| 데이터 결측         | 캔들 카운트<필요수 | 해당 심볼 스킵              |
| 주문 거절          | 응답코드/사유    | 재시도/중단(정책별), Slack 알림 |
| 부분체결           | 체결 웹훅/폴링   | 잔량 관리, 시간제한 후 취소      |
| 손절 미체결         | 시장 급변      | 시장가 대체(한도 내)          |
| DDL 도달         | 실현PnL 집계   | 신규주문 차단 플래그 set       |

---

## 9. 테스트/검증 계획

* **단위 테스트**: 피처 계산(RVOL/RS/VWAP/ATR), 스코어링, 포지션 크기, 파서/정렬.
* **통합 테스트**: 스캐너→신호→모의주문 체인, 예외/리트라이라우팅.
* **E2E(드라이런)**: 실시간 WS + 모의주문, 로그·리포트 생성 검증.
* **성능 테스트**: 200심볼 스캔 시간, WS 메시지 처리량.
* **백테스트(선택)**: 과거 데이터로 전략 유효성, 기대값/낙폭/드로우다운 검증.
* **수용 기준(샘플)**:

  * 스캐너는 2\~3개 후보를 지속적으로 반환한다.
  * 규칙 위반 주문(스프레드>5bp 등)은 차단된다.
  * DDL 도달 시 신규 주문이 즉시 중단된다.

---

## 10. 모니터링·알림

* 메트릭: 신호수, 주문수, 체결율, 승률, 평균R, 일PnL, 오류율, 429 발생수.
* 알림: 임계 이벤트(DDL, 주문거절 다건, WS 장시간 단절) Slack/Email.

---

## 11. 운영 Runbook(요약)

1. 매일 08:30 레짐 체크(BTC 추세/ATR%, 거시 이벤트 확인)
2. 08:50 스캐너 예열(코어+유니버스 동기화)
3. 09:10–13:00 1차 세션, 17:10–19:00 2차 세션
4. 마감 리포트 확인, 다음날 파라미터 조정 1건 기록

---

## 12. 배포·환경

* **언어/런타임**: Python 3.11+
* **패키지**: `requests`, `websockets`, `pandas`, `numpy`, `pyjwt`, `pydantic`, `uvloop`(선택)
* **구성**: `.env` + `config.yaml`
* **배포**: Docker(권장), 시스템 서비스/크론으로 세션 스케줄.

---

## 13. 리포지토리 구조(제안)

```
.
├── src/
│   ├── api/           # REST/WS 클라이언트
│   ├── data/          # 피처 계산, 변환
│   ├── scanner/       # 스코어링, 후보 선정
│   ├── signals/       # ORB/sVWAP/Sweep
│   ├── risk/          # 포지션 크기, DDL
│   ├── order/         # 주문/체결, OCO-like
│   ├── backtest/      # 선택: 시뮬레이션
│   ├── utils/         # 공통(시간대, 로그)
│   └── app.py         # 엔트리포인트
├── configs/
│   └── config.yaml
├── runtime/
│   ├── logs/
│   └── reports/
├── tests/
│   ├── unit/
│   └── integration/
├── docs/
│   └── requirement.md (본 문서 사본)
├── .env.example
├── pyproject.toml
├── Dockerfile
└── Makefile
```

---

## 14. Cursor 개발 워크플로우

* **프롬프트 템플릿**: 각 모듈 상단에 구현 의도/입출력/에러케이스 주석.
* **단계별 빌드**: `scanner → signals → order → risk → app` 순.
* **가드 우선**: 네트워크 예외/스키마 검증/멱등키(주문 UUID) 먼저 구현.
* **테스트 주도**: 피처 계산과 포지션 크기부터 단위 테스트 작성.

---

## 15. 법적 고지·안전장치

* 본 시스템은 **교육/연구 목적**의 샘플 구현 지침입니다. 실제 운용은 사용자 책임 하에 진행되며, **원금 손실 가능**이 큽니다.
* 국내 규제·과세·거래소 약관은 수시 변동되므로 사용자가 최신 규정을 확인해야 합니다.
* API 키/계정 보안, 위험 한도 설정 미비로 인한 손실은 시스템이 책임지지 않습니다.

---

## 16. 변경 이력(초안)

* v0.1 (초안): 요구사항 1차 정리 — 스캐너/신호/주문/리스크/로깅 명세 수립.
